<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>VIDEOPLAY</title>
  <link href="css/video.css" rel="stylesheet" type="text/css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script type="text/javascript" src="XMLHttpRequest.js"></script>
</head>
<body>
<div class="video">
  <div class="video-content">
    <video id="videoID"class="horizontal-img"
           style="object-fit:fill"
           src="./video/test1.MP4"
           preload="metadata"
           webkit-playsinline="true"
           playsinline="true"
           x-webkit-airplay="allow"
           x5-video-player-type="h5"
           x5-video-player-fullscreen="true"
           x5-video-orientation="landscape"
           type='video/mp4'
           muted
           >
        ERROR:CAN'T PLAY THE VIDEO
    </video>

    <label id="mute" for="muteinput">	
        <input id="muteinput" type="checkbox" name="mute" onclick="toggleMute()"/>
        <span id="muteicon"></span>
    </label>

  </div>
  <a href="javascript:void(0);" onclick="toggleMute()"></a>
</div>
<script type="application/javascript">
  /*
  const minute = 1000 * 60;
  const hour = minute * 60;
  const day = hour * 24;
  const year = day * 365;
  */
  var dom = document;
  var index = 0;
  var oldindex = 0;
  var videostest = []
  var path = "https://drive.google.com/uc?export=download&id="
  
  var videoDom = dom.getElementById('videoID');
  
  $(document).ready(function(){
			var file = new XMLHttpRequest();
      file.open("GET", "word/video_ref.txt");
        file.onreadystatechange = function() {
          if (file.readyState === 4) {
            var allText = file.responseText;
            videostest = allText.split(', ')
            console.log(videostest)
          }
        }
        file.send(null);
		});
  
  window.onload=function(){
    find_next_to_play()
  }


  videoDom.addEventListener('ended', function(event) {
    find_next_to_play()
  })
  function find_next_to_play(){
    const d = new Date();
    let time = d.getTime();
    /*
    let years = Math.round(d.getTime() / year);
    let h = addZero(d.getHours());
    let m = addZero(d.getMinutes());
    let s = addZero(d.getSeconds());
    console.log(h+"hour" + m + "mint" + s +"second");
    */  

    index += time;
    index %= videostest.length
    if (index === oldindex) {
        index+=1
        index%=videostest.length
    }
    console.log(index, 'video: ', videostest[index].split('/')[5])

    var xhr = new XMLHttpRequest();
    xhr.open("GET", path+videostest[index].split('/')[5] , true);
    xhr.responseType = "arraybuffer";
    
    xhr.onload = function(oEvent) {
        var blob = new Blob([oEvent.target.response], {type: "video/mp4"});
        videoDOM.src = URL.createObjectURL(blob);
        videoDom.play();
    };

    xhr.onprogress = function(oEvent) {

    if (oEvent.lengthComputable) {
        var percentComplete = oEvent.loaded/oEvent.total;
            console.log("per: " + percentComplete)// do something with this
        }
    }
    xhr.send();    
    oldindex=index
    delete d
  }
  function addZero(i) {
    if (i < 10) {i = "0" + i}
    return i;
  }
  var mute=true;
  function toggleMute() {
   mute=!mute;
   videoDom.muted = !videoDom.muted;
   if(!mute)    $("#muteicon").css("background-image",'url("../image/unmute.png"');
   else         $("#muteicon").css("background-image",'url("../image/mute.png"');
  }
</script>
</body>
</html>
